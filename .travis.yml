language: go
go:
  - 1.12.x
git:
  depth: 1
notifications:
  email:
    on_success: never
stages:
  - test
  - publish
  - release
jobs:
  include:
    - stage: test
      script:
        - go test ./...
        - go build ./...
    - stage: publish
      script:
        - docker build -t ldonini/ocpp1.6-central-system:latest -f example/cs/Dockerfile .
        - docker build -t ldonini/ocpp1.6-charge-point:latest -f example/cp/Dockerfile .
        - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
        - docker push "$DOCKER_IMAGE_CS:latest"
        - docker push "$DOCKER_IMAGE_CP:latest"
      if: branch == master
    - stage: release
      script:
        - docker build -t "ldonini/ocpp1.6-central-system:$TRAVIS_TAG" -f example/cs/Dockerfile .
        - docker build -t "ldonini/ocpp1.6-charge-point:$TRAVIS_TAG" -f example/cp/Dockerfile .
        - echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
        - docker push ocpp-go-1.6-central-system
        - docker push ocpp-go-1.6-charge-point
      if: tag IS present
